#!/bin/bash
# PostgreSQL Backup Script for Citadel Alpha
# Generated by Ansible - database-optimization role

BACKUP_DIR="/var/backups/postgresql"
RETENTION_DAYS="{{ backup_retention_days }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

# Backup all databases
{% for db in databases %}
echo "Backing up database: {{ db.name }}"
pg_dump -h localhost -U {{ db.owner }} -f "$BACKUP_DIR/{{ db.name }}_$TIMESTAMP.sql" {{ db.name }}
if [ $? -eq 0 ]; then
    echo "✅ {{ db.name }} backup completed"
    gzip "$BACKUP_DIR/{{ db.name }}_$TIMESTAMP.sql"
else
    echo "❌ {{ db.name }} backup failed"
fi
{% endfor %}

# Cleanup old backups
echo "Cleaning up backups older than $RETENTION_DAYS days"
find "$BACKUP_DIR" -name "*.sql.gz" -mtime +$RETENTION_DAYS -delete

# Log backup completion
echo "$(date): PostgreSQL backup completed" >> /var/log/postgresql_backup.log
