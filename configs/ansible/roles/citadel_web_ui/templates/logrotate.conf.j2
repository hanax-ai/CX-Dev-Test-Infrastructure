# Citadel Web UI Log Rotation Configuration
# Generated by Ansible - manages log file rotation for web interface
# Path: /etc/logrotate.d/web-ui

{{ app_directory }}/logs/*.log {
    # Rotation frequency
    daily
    
    # Keep logs for 30 days
    rotate 30
    
    # Archive old logs with date suffix
    dateext
    dateformat -%Y%m%d
    
    # Compress old logs (except most recent)
    compress
    delaycompress
    
    # Handle missing log files gracefully
    missingok
    
    # Don't rotate empty log files
    notifempty
    
    # Create new log files with specified permissions
    create 644 www-data www-data
    
    # Use copy and truncate to avoid disrupting running processes
    copytruncate
    
    # Additional options
    sharedscripts
    
    # Post-rotation script to signal log reload
    postrotate
        # Signal PM2 to reopen log files
        if [ -f {{ app_directory }}/web_ui.pid ]; then
            sudo -u www-data pm2 reloadLogs || true
        fi
        
        # Signal nginx to reopen log files if it's managing logs
        if systemctl is-active --quiet nginx; then
            systemctl reload nginx || true
        fi
        
        # Clean up old compressed logs (keep only last 30 days)
        find {{ app_directory }}/logs -name "*.log.*" -type f -mtime +30 -delete || true
    endscript
}

# Nginx access logs for web UI
/var/log/nginx/web-ui.access.log {
    daily
    rotate 14
    dateext
    dateformat -%Y%m%d
    compress
    delaycompress
    missingok
    notifempty
    create 644 www-data adm
    sharedscripts
    
    postrotate
        if systemctl is-active --quiet nginx; then
            systemctl reload nginx || true
        fi
    endscript
}

# Nginx error logs for web UI
/var/log/nginx/web-ui.error.log {
    daily
    rotate 14
    dateext
    dateformat -%Y%m%d
    compress
    delaycompress
    missingok
    notifempty
    create 644 www-data adm
    sharedscripts
    
    postrotate
        if systemctl is-active --quiet nginx; then
            systemctl reload nginx || true
        fi
    endscript
}

# PM2 logs (if managed separately)
/home/www-data/.pm2/logs/*.log {
    daily
    rotate 14
    dateext
    dateformat -%Y%m%d
    compress
    delaycompress
    missingok
    notifempty
    create 644 www-data www-data
    copytruncate
    
    postrotate
        sudo -u www-data pm2 reloadLogs || true
    endscript
}

# System journal logs related to web UI service
# Note: journald handles its own rotation, but we can set retention policy
# This is handled via /etc/systemd/journald.conf:
# SystemMaxUse=500M
# MaxFileSec=1month
# MaxRetentionSec=3month
