---
# Standalone playbook to fix Ollama file permissions
# Run with: ansible-playbook fix-ollama-permissions.yml --limit ai_processing_tier

- name: Fix Ollama File Permissions for AI Processing Tier
  hosts: ai_processing_tier
  gather_facts: yes
  become: yes
  vars:
    model_dir: "/opt/ai_models"
    
  tasks:
    - name: Ensure Ollama user and group exist
      group:
        name: ollama
        state: present
      
    - name: Ensure Ollama user exists
      user:
        name: ollama
        group: ollama
        system: yes
        home: /var/lib/ollama
        shell: /bin/false
        state: present

    - name: Create AI models directory if it doesn't exist
      file:
        path: "{{ model_dir }}"
        state: directory
        mode: '0755'

    - name: Fix Ollama file permissions recursively
      file:
        path: "{{ model_dir }}"
        state: directory
        owner: ollama
        group: ollama
        recurse: yes
      register: permissions_fixed

    - name: Restart Ollama service after permission fix
      systemd:
        name: ollama
        state: restarted
        daemon_reload: yes
      when: permissions_fixed.changed

    - name: Wait for Ollama service to be ready
      wait_for:
        port: 11434
        host: 127.0.0.1
        delay: 5
        timeout: 30
      when: permissions_fixed.changed

    - name: Verify Ollama is accessible
      uri:
        url: "http://127.0.0.1:11434/api/tags"
        method: GET
        timeout: 10
      register: ollama_health_check
      retries: 3
      delay: 5

    - name: Display results
      debug:
        msg:
          - "Permission Fix Results:"
          - "  Directory: {{ model_dir }}"
          - "  Owner: ollama:ollama"
          - "  Recursive: Yes"
          - "  Ollama Status: {{ 'Healthy' if ollama_health_check.status == 200 else 'Needs Attention' }}"
          - "  Changed: {{ permissions_fixed.changed }}"
