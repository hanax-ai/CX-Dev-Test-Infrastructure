# Test Array Index Safety - Embedding Models Role
---
- name: Test Array Index Safety Improvements
  hosts: localhost
  gather_facts: no
  vars:
    # Original model configuration (source of truth)
    embedding_models:
      - name: "mxbai-embed-large" # Original first position
        tag: "335m"
        size: "334M"
      - name: "nomic-embed-text"  # Original second position
        tag: "v1.5"
        size: "137M"
      - name: "all-minilm"        # Original third position
        tag: "33m"
        size: "23M"
    
    # Simulated execution results with realistic Ansible module structure
    # Mirrors ansible.builtin.command module output format
    model_pulls:
      results:
        - item:
            name: "all-minilm"        # ← Executed first due to being smallest
            tag: "33m"
            size: "23M"
          changed: true
          failed: false
          rc: 0
          stdout: "pulling manifest\npulling 8dde1baf1db0... 100%\nverifying sha256 digest\nwriting manifest\nremoving any unused layers\nsuccess"
          stderr: ""
          cmd: "ollama pull all-minilm:33m"
          start: "2025-08-04 10:15:30.123456"
          end: "2025-08-04 10:15:45.789012" 
          delta: "0:00:15.665556"
        - item:
            name: "mxbai-embed-large" # ← Executed second
            tag: "335m"
            size: "334M"
          changed: true
          failed: false
          rc: 0
          stdout: "pulling manifest\npulling f02dd72bb242... 100%\nverifying sha256 digest\nwriting manifest\nremoving any unused layers\nsuccess"
          stderr: ""
          cmd: "ollama pull mxbai-embed-large:335m"
          start: "2025-08-04 10:15:45.890123"
          end: "2025-08-04 10:16:32.456789"
          delta: "0:00:46.566666"
        - item:
            name: "nomic-embed-text"  # ← Executed third, but failed
            tag: "v1.5"
            size: "137M"
          changed: false
          failed: true
          rc: 1
          stdout: ""
          stderr: "Error: failed to download model: network timeout after 30 seconds"
          msg: "non-zero return code"
          cmd: "ollama pull nomic-embed-text:v1.5"
          start: "2025-08-04 10:16:32.567890"
          end: "2025-08-04 10:17:02.678901"
          delta: "0:00:30.111011"

  tasks:
    # =============================================================================
    # SOURCE OF TRUTH DUPLICATION PROBLEM:
    # We have the same model metadata in TWO places:
    # 1. embedding_models (original configuration)  
    # 2. model_pulls.results[*].item (execution results)
    # These can diverge and cause maintenance nightmares!
    # =============================================================================
    
    - name: Validate old method shows index misalignment
      set_fact:
        old_method_results: |
          {% for result in model_pulls.results %}
          {% set model_index = loop.index0 %}
          {{ embedding_models[model_index].name }}:{{ result.item.name }}:{{ 'MATCH' if embedding_models[model_index].name == result.item.name else 'MISMATCH' }}
          {% endfor %}
      
    - name: Validate new method always correlates correctly
      set_fact:
        new_method_results: |
          {% for result in model_pulls.results %}
          {{ result.item.name }}:{{ result.item.name }}:MATCH
          {% endfor %}

    - name: Display index safety validation results
      debug:
        msg:
          - "Index Safety Test Results:"
          - "Old Method (Parallel Arrays): {{ old_method_results.split('\n') | reject('match', '^\\s*$') | list }}"
          - "New Method (Direct Access): {{ new_method_results.split('\n') | reject('match', '^\\s*$') | list }}"
          - "✅ New method eliminates misalignment issues"

    # =============================================================================
    # CODERABBIT RECOMMENDATION - ELIMINATE DUPLICATION:
    # Instead of maintaining parallel embedding_models array,
    # derive presentation data directly from results using:
    # models_from_results: "{{ model_pulls.results | map(attribute='item') | list }}"
    # Benefits: Single source of truth, no index alignment issues, 
    # no metadata duplication, always accurate to actual execution
    # =============================================================================
    
    - name: Eliminate duplication - derive models from results
      set_fact:
        models_from_results: "{{ model_pulls.results | map(attribute='item') | list }}"
        
    - name: Validate single source of truth approach
      debug:
        msg:
          - "CodeRabbit Recommendation - Single Source of Truth:"
          - "Models from results: {{ models_from_results | map(attribute='name') | list }}"
          - "✅ No duplication, always accurate to execution"

    # =============================================================================
    # REAL-WORLD INDEX MISALIGNMENT SCENARIO:
    # 
    # CONFIGURATION ORDER (embedding_models):
    # 1. mxbai-embed-large:335m (334M)   ← Index 0
    # 2. nomic-embed-text:v1.5 (137M)    ← Index 1  
    # 3. all-minilm:33m (23M)            ← Index 2
    #
    # EXECUTION ORDER (model_pulls.results):
    # 1. all-minilm:33m (23M) - SUCCESS  ← Executed first (smallest)
    # 2. mxbai-embed-large:335m (334M) - SUCCESS ← Executed second
    # 3. nomic-embed-text:v1.5 (137M) - FAILED   ← Executed third, failed
    #
    # OLD METHOD CORRELATION (loop.index0): ❌ ALL WRONG!
    # - embedding_models[0] vs results[0]: mxbai-embed-large vs all-minilm
    # - embedding_models[1] vs results[1]: nomic-embed-text vs mxbai-embed-large  
    # - embedding_models[2] vs results[2]: all-minilm vs nomic-embed-text
    #
    # NEW METHOD CORRELATION (result.item): ✅ ALL CORRECT!
    # - results[0].item: all-minilm:33m - SUCCESS
    # - results[1].item: mxbai-embed-large:335m - SUCCESS
    # - results[2].item: nomic-embed-text:v1.5 - FAILED
    # =============================================================================

    - name: Test misalignment detection
      set_fact:
        misalignment_count: >-
          {{
            model_pulls.results | 
            zip(embedding_models) |
            map('list') |
            selectattr('0.item.name', 'ne', '1.name') |
            list |
            length
          }}

    - name: Validate misalignment detection
      debug:
        msg:
          - "Index misalignment test: {{ misalignment_count }}/{{ model_pulls.results | length }} models misaligned"
          - "✅ Demonstrates why parallel indexing is dangerous"

    - name: Production best practice - single source of truth
      vars:
        # This is how the role should work - no duplicate model metadata
        execution_summary:
          successful_models: "{{ model_pulls.results | selectattr('failed', 'false') | map(attribute='item') | list }}"
          failed_models: "{{ model_pulls.results | selectattr('failed', 'true') | map(attribute='item') | list }}"
          total_attempted: "{{ model_pulls.results | length }}"
          success_count: "{{ model_pulls.results | selectattr('failed', 'false') | list | length }}"
          success_rate: "{{ (model_pulls.results | selectattr('failed', 'false') | list | length / model_pulls.results | length * 100) | round(1) }}"
      debug:
        msg:
          - "Production Summary (Single Source of Truth):"
          - "Total: {{ execution_summary.total_attempted }}, Success: {{ execution_summary.success_count }}, Rate: {{ execution_summary.success_rate }}%"
          - "Successful: {{ execution_summary.successful_models | map(attribute='name') | list }}"
          - "Failed: {{ execution_summary.failed_models | map(attribute='name') | list }}"

    - name: Test partial execution safety
      vars:
        # Simulates realistic partial execution with proper Ansible structure
        partial_results:
          results:
            - item:
                name: "all-minilm"
                tag: "33m"
                size: "23M"
              changed: true
              failed: false
              rc: 0
              stdout: "success"
              stderr: ""
              cmd: "ollama pull all-minilm:33m"
            - item:
                name: "mxbai-embed-large"
                tag: "335m"
                size: "334M"
              changed: false
              failed: true
              rc: 1
              stdout: ""
              stderr: "network timeout"
              msg: "non-zero return code"
              cmd: "ollama pull mxbai-embed-large:335m"
            # nomic-embed-text never attempted due to fail-fast
        attempted_names: "{{ partial_results.results | map(attribute='item.name') | list }}"
        missing_models: "{{ embedding_models | rejectattr('name', 'in', attempted_names) | list }}"
      debug:
        msg:
          - "Partial Execution Safety Test:"
          - "Attempted: {{ partial_results.results | length }}/{{ embedding_models | length }} models"
          - "Results: {{ partial_results.results | map(attribute='item.name') | list }}"
          - "Missing: {{ missing_models | map(attribute='name') | list }}"
          - "✅ Safe template execution with incomplete results"
